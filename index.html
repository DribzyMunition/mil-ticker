<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>MIL-Ticker</title>
<style>
  *{box-sizing:border-box}
  :root{
    --bg:#0b0f14;
    --panel:#121821;
    --text:#e6edf3;
    --muted:#8a96a3;
    --up:#25b45b;
    --down:#ff5c5c
  }

 body {
  margin: 0;
  background-color: var(--bg);
  color: var(--text);
  font: 16px/1.5 system-ui, Segoe UI, Roboto;
}

  /* starfield overlay */
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: transparent;
    pointer-events: none;
    z-index: 0;
  }

  .star {
    position: fixed;
    background: white;
    border-radius: 50%;
    opacity: 0.8;
    animation: twinkle 6s infinite alternate;
    z-index: 0;
  }

  @keyframes twinkle {
    from { opacity: 0.2; }
    to   { opacity: 0.9; }
  }

  header{
    display:flex;
    align-items:center;
    gap:.6rem;
    padding:1rem;
    border-bottom:1px solid #1d2430
  }
  .ticker-wrap{
    overflow:hidden;
    white-space:nowrap;
    border-bottom:1px solid #1d2430;
    background:#0d131b
  }
  .ticker{
    display:inline-block;
    white-space:nowrap;
    padding:.6rem 0;
    animation:marquee 40s linear infinite
  }
  .ticker:hover{animation-play-state:paused;cursor:ew-resize}
  @keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
  .titem{
    display:inline-flex;
    gap:.5rem;
    align-items:center;
    padding:0 .9rem;
    border-right:1px solid #1b2330
  }
  .tname{color:var(--muted);font-weight:600}
  .tpct.up{color:var(--up)} 
  .tpct.down{color:var(--down)}
  .tpct.big{
    font-weight:bold;
    color:#ffcf40;
    text-shadow:0 0 4px #ffcf40
  }
  main{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:1rem;
    padding:1rem;
    max-width:1100px;
    margin:0 auto
  }
  section{
    background:var(--panel);
    border:1px solid #1d2430;
    border-radius:14px;
    padding:1rem
  }
  h2{margin:.2rem 0 .6rem 0;font-size:1rem;color:#c8d2de}
  ul{
    list-style:none;
    margin:0;
    padding:0;
    display:grid;
    gap:.4rem
  }
  li{
    display:flex;
    justify-content:space-between;
    gap:.75rem;
    padding:.5rem .6rem;
    background:#0e141d;
    border:1px solid #1b2330;
    border-radius:10px
  }
  small{color:var(--muted)}
  .err{
    display:none;
    padding:.6rem .9rem;
    background:#2a1111;
    border-bottom:1px solid #512020;
    color:#ffbdbd
  }
  a{color:#4da3ff;text-decoration:none}
  a:hover{text-decoration:underline}

.right { display:flex; align-items:center; gap:.5rem; }
.price-muted { color: var(--muted); font-variant-numeric: tabular-nums; }

 
  /* Divider between Tier 1 and Tier 2 */
  .tier-divider{
    grid-column: 1 / -1;
    display:flex;
    align-items:center;
    gap:12px;
    margin:3rem 0 1.5rem 0;
  }
  .tier-divider::before,
  .tier-divider::after{
    content:"";
    height:0;
    border-top:2px solid #1d2430;
    flex:1;
  }
  #updated{ color: var(--muted); font-size:.9rem }
</style>
</head>

<body>
<header><h1 style="margin:0">MIL-Ticker</h1><small>— MVP</small></header>
<div id="err" class="err"></div>

<div class="ticker-wrap"><div class="ticker" id="ticker"></div></div>

<main>
  <!-- Tier 1: core boxes -->
  <section>
    <h2>New Contracts</h2>
    <ul id="contracts"></ul>
  </section>

  <section>
    <h2>Commodity Moves</h2>
    <ul id="commodities"></ul>
  </section>

  <section>
    <h2>Conflict Watch</h2>
    <ul id="conflicts"></ul>
  </section>

  <!-- Divider with timestamp (between tiers) -->
  <div class="tier-divider">
    <span id="updated"></span>
  </div>

  <!-- Tier 2: extended boxes -->
  <section>
    <h2>Clothing</h2>
    <ul id="apparel"></ul>
  </section>
</main>

<script>
function money(n){return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0})}
function fmtTime(t){
  let d = (typeof t === 'number') ? new Date(t*1000) : new Date(t);
  if (isNaN(d)) d = new Date();
  return d.toLocaleString(undefined,{hour12:false});
}
function showError(msg){
  const e = document.getElementById('err');
  e.textContent = msg;
  e.style.display = 'block';
}
function hideError(){document.getElementById('err').style.display='none'}

async function load(){
  try{
    const res = await fetch('public/data.json?ts=' + Date.now());
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    document.getElementById('updated').textContent =
      'Last updated: ' + fmtTime(data.generated_at || Date.now()/1000);

    renderTicker(data);
    renderLists(data);
    hideError();
  }catch(err){
    showError('Data load failed: ' + err.message);
  }
}

function renderTicker(d){
  const el = document.getElementById('ticker');
  const parts = [];

  // Commodities: sort by absolute % move (robust to missing/NaN)
  [...(d.commodities || [])]
    .sort((a,b)=>(Math.abs(Number(b.pct)||0) - Math.abs(Number(a.pct)||0)))
    .forEach(c=>{
      const pctVal  = Number(c.pct);
      const pctSafe = Number.isFinite(pctVal) ? pctVal : 0;
      const dir     = pctSafe >= 0 ? 'up' : 'down';
      const arrow   = pctSafe > 0 ? '▲' : (pctSafe < 0 ? '▼' : '•');

      const priceVal = Number(c.price);
      const pstr     = Number.isFinite(priceVal) ? `$${priceVal.toFixed(2)}` : '—';
      const pctStr   = Number.isFinite(pctVal) ? `${arrow}${Math.abs(pctSafe).toFixed(2)}%` : '—';

      parts.push(
        `<span class="titem"><span class="tname">${c.name}</span>`+
        `<span>${pstr}</span>`+
        `<span class="tpct ${dir} ${Math.abs(pctSafe)>=2?'big':''}">${pctStr}</span></span>`
      );
    });

  // Contracts: sort by descending value
  [...(d.contracts || [])]
    .sort((a,b)=>b.value_usd - a.value_usd)
    .forEach(ct=>{
      parts.push(
        `<span class="titem"><span class="tname">${ct.entity}</span>`+
        `<span>${money(ct.value_usd)}</span>`+
        `<small>${ct.note||''}</small></span>`
      );
    });

  // Conflicts: keep order
  (d.conflicts || []).forEach(cf=>{
    parts.push(
      `<span class="titem"><span class="tname">${cf.name}</span><small>${cf.note||''}</small></span>`
    );
  });

  // Duplicate for continuous scroll
  el.innerHTML = parts.join('') + parts.join('');
}


function renderLists(d){
  const mk=(arr,map,id)=>{
    const ul=document.getElementById(id);
    ul.innerHTML='';
    (arr||[]).forEach(x=>{
      const li=document.createElement('li');
      li.innerHTML=map(x);
      ul.appendChild(li);
    });
  };

  // Contracts
  mk(d.contracts, x=>`<span>${x.entity}</span><span>${money(x.value_usd)}</span>`, 'contracts');

  // Commodities — PRICE (muted) + PERCENT (hero)
  mk(d.commodities, x=>{
    const priceVal = Number(x.price);
    const priceStr = Number.isFinite(priceVal) ? `$${priceVal.toFixed(2)}` : '—';

    const pctVal  = Number(x.pct);
    const pctSafe = Number.isFinite(pctVal) ? pctVal : 0;
    const dir     = pctSafe>=0 ? 'up' : 'down';
    const arrow   = pctSafe>0 ? '▲' : (pctSafe<0 ? '▼' : '•');
    const pctStr  = Number.isFinite(pctVal) ? `${arrow}${Math.abs(pctSafe).toFixed(2)}%` : '—';

    return `<span>${x.name}</span>`+
           `<span class="right">`+
             `<span class="price-muted">${priceStr}</span>`+
             `<span class="tpct ${dir} ${Math.abs(pctSafe)>=2?'big':''}">${pctStr}</span>`+
           `</span>`;
  }, 'commodities');

  // Conflicts
  mk(d.conflicts, x=>`<span>${x.name}</span><small>${x.note||''}</small>`, 'conflicts');

  // Apparel
  mk(d.apparel, x=>`<span>${x.brand}</span><small>${x.note||''}</small>`, 'apparel');
}


document.addEventListener('DOMContentLoaded', load);
setInterval(load, 60000);
</script>

<script>
  // generate scattered stars
  for(let i=0; i<60; i++){
    const star = document.createElement("div");
    star.className = "star";
    const size = Math.random()*2 + 1; // 1px to 3px
    star.style.width = size + "px";
    star.style.height = size + "px";
    star.style.left = Math.random()*100 + "vw";
    star.style.top = Math.random()*100 + "vh";
    star.style.animationDuration = (3 + Math.random()*5) + "s";
    document.body.appendChild(star);
  }
</script>

</body>
</html>
